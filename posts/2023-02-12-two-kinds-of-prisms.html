<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
    <head>
        <!-- Google tag (gtag.js) -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-PWZE1HYS87"></script>
        <script>
         window.dataLayer = window.dataLayer || [];
         function gtag(){dataLayer.push(arguments);}
         gtag('js', new Date());

         gtag('config', 'G-PWZE1HYS87');
        </script>

        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <meta name="author" content="Bruno Gavranovic" />
        <meta name="viewport" content="width=device-width" />
        <meta http-equiv="Cache-Control" content="max-age=86400, must-revalidate" />
        <title>Two kinds of Prisms</title>
        <script src="../css/jquery.js"></script>
        <script src="../css/selectfile.js"></script>
        <link rel="stylesheet" type="text/css" title="hakyll_theme" href="../css/theprofessional.css" />
        <link href="https://fonts.googleapis.com/css?family=Titillium+Web" rel="stylesheet">

        <!-- MathJax font size adjustment -->
        <style>
            mjx-container {
                font-size: 80% !important;
            }

            /* Scale TikZ diagrams uniformly */
            .page svg {
                transform: scale(1.2) !important;
                transform-origin: center !important;
            }

            /* Improve code blocks */
            pre, code {
                background-color: #f8f9fa;
                border: 1px solid #e1e4e8;
                border-radius: 3px;
                font-family: 'Monaco', 'Menlo', 'Courier New', monospace;
                font-size: 0.9em;
            }

            pre {
                padding: 1em;
                overflow-x: auto;
            }

            code {
                padding: 0.2em 0.4em;
            }

            pre code {
                background: none;
                border: none;
                padding: 0;
            }
        </style>

        <!-- MathJax for regular math -->
        <script>
            MathJax = {
                tex: {
                    macros: {
                        coloneqq: '\\mathrel{\\vcenter{:}}=',
                        enskip: '\\hspace{0.5em}'
                    }
                }
            };
        </script>
        <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>

        <!-- TikZJax for TikZ diagrams -->
        <link rel="stylesheet" type="text/css" href="https://tikzjax.com/v1/fonts.css">
        <script src="https://tikzjax.com/v1/tikzjax.js"></script>
    </head>
    <body>
        <div class="highbar">&nbsp;</div>
        <div class="container-gallery">
        <div id="content" class="inside">

        <div id="header">
          <div class="box">
            <div id="logo" class="name">
                <h2><pageTitle><a href="../">Bruno Gavranović</a></pageTitle></h2>
            </div>
            <div id="navigation" class="pageslinks">
              <nav class="menuNav">
                <div class="menuItems">
                <a href="../" class="posts/2023-02-12-two-kinds-of-prisms.md">Home</a>
                <a href="../archive.html" class="posts/2023-02-12-two-kinds-of-prisms.md">Posts</a>
                <a href="../papers.html" class="posts/2023-02-12-two-kinds-of-prisms.md">Papers</a>
                <a href="../research_programme.html" class="posts/2023-02-12-two-kinds-of-prisms.md">Research Programme</a>
                <a href="../about.html" class="posts/2023-02-12-two-kinds-of-prisms.md">About</a>
		<!-- <a href="/contact.html" class="posts/2023-02-12-two-kinds-of-prisms.md">Contact</a> -->
                </div>
              </nav>
            </div>
        </div>
        </div>
            <script src="https://unpkg.com/commentbox.io/dist/commentBox.min.js"></script>

<div class="info">
    Posted on February 12, 2023
    
</div>

<h1 id="two-kinds-of-prisms">Two kinds of Prisms</h1>
<center>
<img src="../images/pink_floyd_prism.png" alt="Pink Floyd had nothing to do with category theory, (un)fortunately." width="400" />
</center>
<p>If you are a functional programmer, you have probably heard of lenses and prisms.
They are bidirectional structures often said to be dual to each other.
You might know them from Haskell’s <a href="https://hackage.haskell.org/package/lens">lens</a> library, the recent paper on <a href="https://arxiv.org/abs/2001.07488">Profunctor Optics</a>, or other places (such as my two blog posts (<a href="https://www.brunogavranovic.com/posts/2022-01-05-lenses-to-the-left-of-me.html">1</a>, <a href="https://www.brunogavranovic.com/posts/2022-02-10-optics-vs-lenses-operationally.html">2</a>).</p>
<p>While lenses are extensively used in practice and a topic of considerable discussion, the same cannot be said for prisms: they seemingly hold a more mysterious flavour.
What is even a prism? What does it do operationally, and what does it mean to be dual to a lens?
In this blog post I unpack the answers to these questions, and show that there are <em>two</em> different but related ways of being dual to a lens, and that the way in which they are related is subtle, not obvious, and does not generalise to dependent types.
This is not something I have seen discussed before, so I am recording it here for posterity.</p>
<p>Let’s just quickly recap what a lens is, and how it’s related to an optic.
Given a cartesian category <span class="math inline">\(\mathcal{C}\)</span>, a lens <span class="math inline">\((A, A') \to (B, B')\)</span> consists of the forward map <span class="math inline">\(\text{get} : A \to B\)</span> and the backward map <span class="math inline">\(\text{put}: A \times B' \to A'\)</span>.<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>
Lenses are morphisms in the category <span class="math inline">\(\mathbf{Lens}(\mathcal{C})\)</span> whose objects are pairs of objects in <span class="math inline">\(\mathcal{C}\)</span>.
This is their concrete definition. You can also see lenses as special cases of optics.
An optic <span class="math inline">\((A, A') \to (B, B')\)</span> over a monoidal category <span class="math inline">\(\mathcal{M}\)</span> is defined as an element of the following coend <span class="math inline">\(\int^M \mathcal{M}(A, M \otimes B) \times \mathcal{M}(M \otimes B', A')\)</span>.
If you set the monoidal category <span class="math inline">\(\mathcal{M}\)</span> to be the previously defined cartesian category <span class="math inline">\(\mathcal{C}\)</span>, then you can reduce the above representation to lenses.<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a></p>
<p>Great, so how is a prism dual to a lens? There are two ways. Given a cocartesian category <span class="math inline">\(\mathcal{C}\)</span>, you can define a prism as either:</p>
<ul>
<li>an element of the hom-set <span class="math inline">\(\mathbf{Optic}(\mathcal{C})((A, A'), (B, B'))\)</span>, or</li>
<li>an element of the hom-set <span class="math inline">\(\mathbf{Lens}(\mathcal{C}^{op})((A, A'), (B, B'))\)</span>.</li>
</ul>
<p>The first definition is dual to a lens because we’re instantiating optics for a cocartesian (instead of a cartesian) category, and the second definition is dual because we’re instantiating lenses in the opposite category.
Many people casually reference prisms as being dual to lenses, but they seldom reference which duality they’re referring to. And as it turns out that, while these are related, they give a markedly different way of thinking about prisms.
Let’s see why.</p>
<p>If we unpack the prism-as-optic definition, we have the following chain of isomorphisms:</p>
<center>
<span class="math display">\[
\begin{aligned}
&amp; \mathbf{Optic}(\mathcal{C})((A, A'), (B, B')) \\
\coloneqq
&amp; \int^M \mathcal{C}(A, M + B) \times \mathcal{C}(M + B', A') \\
\cong
&amp; \int^M \mathcal{C}(A, M + B) \times \mathcal{C}(M, A') \times \mathcal{C}(B', A') \\
\cong
&amp; \enskip \mathcal{C}(A, A' + B) \times \mathcal{C}(B', A')
\end{aligned}
\]</span>
</center>
<p>where the first isomorphism is given by the universal property of coproduct, and second one by Yoneda reduction.
This gives us two types of maps in <span class="math inline">\(\mathcal{C}\)</span> which we’ll call <span class="math inline">\(\text{match} : A \to A' + B\)</span> and <span class="math inline">\(\text{build} : B' \to A'\)</span>.
If we unpack lens-in-the-opposite-category definition, we get this chain:</p>
<center>
<span class="math display">\[
\begin{aligned}
&amp; \enskip \mathbf{Lens}(\mathcal{C}^{op})((A, A'), (B, B')) \\
\cong
&amp; \enskip \mathcal{C}^{op}(A, B) \times \mathcal{C}^{op}(A \times B', A') \\
=
&amp; \enskip \mathcal{C}(B, A) \times \mathcal{C}(A', A + B')
\end{aligned}
\]</span>
</center>
<p>The two resulting maps are also often called <span class="math inline">\(\text{build} : B \to A\)</span> and <span class="math inline">\(\text{match} : A' \to A + B'\)</span>. Let’s write them both unpackings side by side.</p>
<br>
<center>
<!-- % https://q.uiver.app/?q=WzAsOCxbMCwwLCJcXG1hdGhiZntPcHRpY30oXFxtYXRoY2Fse0N9KSgoQSwgQScpLCAoQiwgQicpKSJdLFswLDEsIlxcdGV4dHttYXRjaH0gOiBBIFxcdG8gQScgKyBCIl0sWzAsMiwiXFx0ZXh0e2J1aWxkfSA6IEInIFxcdG8gQSciXSxbNCwwLCJcXG1hdGhiZntMZW5zfShcXG1hdGhjYWx7Q31ee29wfSkoKEEsIEEnKSwgKEIsIEInKSkiXSxbNCwxLCJcXHRleHR7YnVpbGR9IDogQiBcXHRvIEEiXSxbNCwyLCJcXHRleHR7bWF0Y2h9IDogQScgXFx0byBBICsgQiciXSxbMSw2XSxbMiwwLCJcXHRleHR7b3J9Il1d -->
<script type="text/tikz">
\begin{tikzcd}[ampersand replacement=\&]
	{\mathbf{Optic}(\mathcal{C})((A\text{,} A')\text{,} (B\text{,} B'))} \&\& {\text{or}} \&\& {\mathbf{Lens}(\mathcal{C}^{op})((A\text{,} A')\text{,} (B\text{,} B'))} \\
	{\text{match} : A \to A' + B} \&\&\&\& {\text{build} : B \to A} \\
	{\text{build} : B' \to A'} \&\&\&\& {\text{match} : A' \to A + B'}
\end{tikzcd}
</script>
</center>
<p><br></p>
<p>It’s clear that they’re different!
Even though they have the same “shape”, the way the ports <span class="math inline">\((A, A')\)</span> and <span class="math inline">\((B, B')\)</span> are bound to parts of the two maps are different in these two cases.</p>
<p>So what does this mean, and why is this important?
Well, I’m trying to understand what prisms “really” do, in the operational sense. Where does information first enter? What happens to it? Is there branching or copying? Is some additional information required to produce certain kind of output? And so on. These are important for actually building something using prisms.
But I only have a clear picture for <em>one</em> of the definitions.
It’s the one that sees them as optics.</p>
<p>I wrote about this definition in my <a href="https://www.brunogavranovic.com/posts/2022-01-05-lenses-to-the-left-of-me.html">previous blog post</a>. I also animated it below: we start at <span class="math inline">\(A\)</span>, and then we either a) short-circuit the computation by moving straight down back to <span class="math inline">\(A'\)</span>, or b) we query the environment with a <span class="math inline">\(B\)</span> and wait for a response <span class="math inline">\(B'\)</span>, subsequently turning it into an <span class="math inline">\(A'\)</span>.</p>
<center>
<p float="left">
<img src="../images/prism_default_resized.gif" alt="Prism trace" width="400" />
<img src="../images/prism_env_resized.gif" alt="Prism trace" width="400" />
</p>
</center>
<p>The other picture – where a prism <span class="math inline">\((A, A') \to (B, B')\)</span> consists of maps <span class="math inline">\(\text{build} : B \to A\)</span> and <span class="math inline">\(\text{match} : A' \to A + B'\)</span> – does not give us anything like that. Which way does the information flow here? Does <span class="math inline">\(\text{build}\)</span> happen before <span class="math inline">\(\text{match}\)</span>? Do we start at <span class="math inline">\(B\)</span>, and then build an <span class="math inline">\(A\)</span>, meaning we go backwards? Or is there something else at play?
It’s not clear. People usually say “prisms are lenses in the opposite category” and then stop there, without telling us how to think about the internal data flow.</p>
<p>As it turns out<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a>, these two dualities are related by the following subtle isomorphism:</p>
<center>
<span class="math display">\[
\mathbf{Optic}(\mathcal{C})^{op} \cong \mathbf{Lens}(\mathcal{C}^{op})
\]</span>
</center>
<p>This isomorphism simply takes the opposite of category of optics, but the reason why it is subtle is because on objects it swaps the order of forwards and backwards morphisms!
That is, given a pair <span class="math inline">\((A, A')\)</span> on the left, we map it to <span class="math inline">\((A', A)\)</span> on the right.
On morphisms, it ends up doing the only thing it can! (It’s worth unpacking this for yourself)
This then explains why we had two different dualities – this was because we had not applied the approrpiate swap of forwards and backwards objects.</p>
<p>While this is a well-defined isomorphism, it breaks when we move on to the dependent case, i.e. where the type of the backwards objects depends on the value of the forwards one.
In this case we no longer have the luxury of swaps, and dependent prisms take on a whole new form.
This is the main reason I prefer the optic definition of prisms. The other reason is that it provides us with a mechanism for composing prisms with lenses to obtain affine traversals. Such a mechanism is missing from the other definition.</p>
<p>This makes me skeptical about using the second definition in practice. I haven’t been able to find any nice stories about the other definition, and at this point, I’m starting to wonder whether the fact that “prisms are lenses in the opposite category” is just a misleading coincidence applicable only in the non-dependent case, and only when the only optics of interest are prisms themselves.</p>
<section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes">
<hr />
<ol>
<li id="fn1"><p>Intuition about what a lens is can be found <a href="https://www.brunogavranovic.com/posts/2022-02-10-optics-vs-lenses-operationally.html">here</a>.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>Details of this reduction can be found in <a href="https://www.brunogavranovic.com/posts/2022-02-10-optics-vs-lenses-operationally.html">my blog post</a> I previously referenced, or in the <a href="https://arxiv.org/abs/2001.07488">Profunctor Optics</a> paper.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>This was pointed out to me by Jeremy Gibbons.<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section>

<div class="commentbox"></div>


<script>
commentBox('5769281040023552-proj');
</script>

        <div id="footer">
          <div class="inside">
            Licensed under <a href="https://creativecommons.org/licenses/by-sa/4.0/"> CC BY-SA 4.0</a>
            Site proudly generated by
            <a href="http://jaspervdj.be/hakyll">Hakyll</a>.
            The theme originates in the <a href="http://katychuang.com/hakyll-cssgarden/gallery/">Hakyll-CSSGarden</a>.
          </div>
        </div>

          </div>
        </div>
    </body>
</html>
